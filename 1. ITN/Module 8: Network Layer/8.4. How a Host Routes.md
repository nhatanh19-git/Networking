
| **Title** | 8.4. How a Host Routes |
|:---------:|:-----------------------:|
| **ID**    | CCNET040                |
| **Tag**   | CCNA, Cisco, Routing, IPv4, IPv6, Default Gateway |

---

# 8.4. How a Host Routes

Sau khi hiểu cách gói tin IPv6 được tạo và xử lý, ta cần biết **làm thế nào một thiết bị đầu cuối (host)** quyết định gửi gói tin đi đâu — trong mạng nội bộ hay ra ngoài Internet.  
Phần này sẽ giúp bạn hình dung cách host **định tuyến (route)**, **sử dụng default gateway**, và **quản lý bảng định tuyến nội bộ**.

---

## 8.4.1. Host Forwarding Decision

Khi một thiết bị (host) gửi dữ liệu đi, gói tin **luôn được tạo tại host nguồn**. Lúc này, host cần xác định xem **gói tin nên gửi đến đâu** — thiết bị trong cùng mạng hay một mạng khác.  
Để làm điều này, **mỗi host tự xây dựng một bảng định tuyến (routing table)** của riêng nó.

###  Ba hướng gửi gói tin của host:

1. **Gửi cho chính nó (Itself)**  
   - Sử dụng địa chỉ đặc biệt gọi là **loopback address**  
     - IPv4: `127.0.0.1`  
     - IPv6: `::1`  
   - Dùng để kiểm tra **TCP/IP stack** của chính thiết bị (ví dụ: `ping 127.0.0.1`).

2. **Gửi cho host trong cùng mạng (Local Host)**  
   - Khi thiết bị đích nằm **trong cùng subnet**, host sẽ **gửi trực tiếp** qua switch hoặc access point.

3. **Gửi cho host ở mạng khác (Remote Host)**  
   - Khi thiết bị đích thuộc **mạng khác subnet**, host **phải gửi gói tin qua router**, gọi là **default gateway**.

---

### Cách host xác định “cùng mạng” hay “khác mạng”:

<p align="center">
  <img src="../../images/kì 1/module 8/8.4.1.jpg" width="480"/>
</p>

- **IPv4:** So sánh **địa chỉ IP đích** với **địa chỉ IP nguồn và subnet mask**.  
- **IPv6:** Router quảng bá (advertise) **prefix của mạng cục bộ**, giúp các host tự xác định phạm vi mạng.

> Ví dụ:  
> Nếu PC1 có IP 192.168.10.10/24 và cần gửi đến 192.168.10.20 → cùng mạng, gửi trực tiếp.  
> Nếu gửi đến 172.16.5.3 → khác mạng, phải qua router (default gateway).

---

## 8.4.2. Default Gateway

**Default Gateway** là thiết bị (thường là **router** hoặc **Layer 3 switch**) chịu trách nhiệm **đưa gói tin ra ngoài mạng nội bộ**.  
Nếu coi mạng là một căn phòng, thì **default gateway chính là cánh cửa** giúp ta đi đến phòng khác.

###  Đặc điểm của default gateway:

- Có địa chỉ IP **nằm trong cùng subnet** với các thiết bị nội bộ.  
- Có khả năng **nhận dữ liệu từ mạng cục bộ** và **chuyển tiếp ra mạng khác**.  
- Là thiết bị **duy nhất biết cách đến các mạng còn lại**.

> Nếu không cấu hình default gateway (hoặc gateway bị tắt), host **chỉ giao tiếp được nội bộ**, không thể truy cập Internet.

---

## 8.4.3. A Host Routes to the Default Gateway

Trong bảng định tuyến của host luôn có một **default route** – đường đi mặc định đến các mạng xa lạ.

- Với **IPv4**, default gateway có thể được:
  - **Cấp phát tự động(dynamic)** qua **DHCP**  
  - Hoặc **cấu hình thủ công(manual)**
- Với **IPv6**, router sẽ **quảng bá địa chỉ gateway** bằng **Router Advertisement (RA)** hoặc người dùng cấu hình thủ công.

<p align="center">
  <img src="../../images/kì 1/module 8/8.4.3.jpg" width="520"/>
</p>

**Ví dụ:**  
PC1 và PC2 đều được cấu hình default gateway là `192.168.10.1`.  
Điều này tạo ra **default route** trong bảng định tuyến của cả hai thiết bị.  
→ Tất cả gói tin có địa chỉ đích không thuộc mạng `192.168.10.0/24` sẽ được gửi đến router R1 tại `192.168.10.1`.

---

## 8.4.4. Host Routing Tables

Mỗi thiết bị mạng đều có **bảng định tuyến riêng**, lưu thông tin về các mạng mà nó biết cách đến.  
Trên Windows, bạn có thể kiểm tra bảng định tuyến bằng lệnh:

```bash
netstat -ru
```
 hoặc 
 
```bash
route print
```
<p align="center"> <img src="../../images/kì 1/module 8/8.4.4.jpg" width="520"/> </p>

### Ví dụ – Bảng định tuyến IPv4 của PC1

```bash
C:\Users\PC1> **netstat -r**

IPv4 Route Table
===========================================================================
Active Routes:
Network Destination         Netmask       Gateway       Interface    Metric
          0.0.0.0           0.0.0.0   192.168.10.1   192.168.10.10       25
        127.0.0.0         255.0.0.0       On-link        127.0.0.1      306
        127.0.0.1   255.255.255.255       On-link        127.0.0.1      306
  127.255.255.255   255.255.255.255       On-link        127.0.0.1      306
     192.168.10.0     255.255.255.0       On-link    192.168.10.10      281
    192.168.10.10   255.255.255.255       On-link    192.168.10.10      281
   192.168.10.255   255.255.255.255       On-link    192.168.10.10      281
        224.0.0.0         240.0.0.0       On-link        127.0.0.1      306
        224.0.0.0         240.0.0.0       On-link    192.168.10.10      281
  255.255.255.255   255.255.255.255       On-link        127.0.0.1      306
  255.255.255.255   255.255.255.255       On-link    192.168.10.10      281
```

### Giải thích:

-   **0.0.0.0 / 0.0.0.0 → Gateway 192.168.10.1:**  
    Đây là **default route**, mọi gói tin đến mạng ngoài sẽ đi qua địa chỉ này.
    
-   **192.168.10.0 / 255.255.255.0 → On-link:**  
    Mạng cục bộ (LAN) mà thiết bị đang kết nối trực tiếp.

### Các phần trong kết quả lệnh `netstat -r`

1.  **Interface List** – Liệt kê tất cả card mạng (Ethernet, Wi-Fi, Bluetooth) cùng địa chỉ MAC.
    
2.  **IPv4 Route Table** – Hiển thị các tuyến đường cho IPv4 (mạng cục bộ, trực tiếp, hoặc mặc định).
    
3.  **IPv6 Route Table** – Tương tự, dành cho các tuyến IPv6.
    
