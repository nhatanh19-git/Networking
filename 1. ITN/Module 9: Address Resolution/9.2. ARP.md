
| **Title** | 9.2. ARP |
|:---------:|:--------------------------------------:|
| **ID**    | CCNET043                               |
| **Tag**   | CCNA, Cisco, ARP, IPv4, Ethernet, L2, L3 |

---

## 9.2.1. ARP Overview

ARP (**Address Resolution Protocol**) được sử dụng trong mạng IPv4 để ánh xạ địa chỉ lớp 3 (**IPv4**) sang địa chỉ lớp 2 (**MAC**) trước khi gửi frame trong mạng LAN.  
Nếu một thiết bị biết **IPv4 đích** nhưng chưa biết **địa chỉ MAC**, ARP sẽ được sử dụng để xác định thông tin này.

<p align="center">
  <img src="../../images/kì 1/module 9/9.2.1.jpg" width="520"/>
</p>

Mỗi thiết bị trên mạng Ethernet có một ** địa chỉ MAC duy nhất**.  
Khi gửi frame, thiết bị cần hai thông tin:

- **Destination MAC address**
- **Source MAC address**

Nếu thiếu MAC đích, ARP sẽ giúp tìm thông qua việc broadcast trên LAN.

ARP có hai chức năng chính:

| Chức năng | Mô tả |
|-----------|-------|
| Resolve IPv4 to MAC | Tìm MAC tương ứng với IPv4 đích |
| Maintains ARP Table | Lưu ánh xạ IPv4 ↔ MAC tạm thời trong RAM |

---

## 9.2.2. ARP Functions

Thiết bị sử dụng **ARP Table** (ARP Cache) để tra cứu ánh xạ IPv4 ↔ MAC.

Quy trình:

1. Kiểm tra IPv4 đích có trùng mạng với local host hay không.
2. Tìm IPv4 trong **ARP Table**:
   - Nếu có → dùng MAC tương ứng.
   - Nếu không có → gửi **ARP Request**.
3. Nếu gửi tới mạng khác → MAC đích sẽ là MAC của **default gateway**.

**Mỗi bản ghi trong ARP Table được gọi là một *map entry*.**

<p align="center">
  <img src="../../images/kì 1/module 9/9.2.2.gif" width="520"/>
</p>

---

## 9.2.3. Video - ARP Request

Nếu không có ánh xạ trong ARP Table, thiết bị gửi **ARP Request broadcast**, chứa:

| Header Field | Giá trị |
|--------------|---------|
| Destination MAC | FF-FF-FF-FF-FF-FF |
| Source MAC | MAC của thiết bị gửi |
| Type | 0x806 (EtherType ARP - Giá trị này chỉ định rằng phần dữ liệu theo sau trong khung là một gói tin ARP) |

Switch **broadcast** gói ARP request ra toàn mạng LAN (ngoại trừ cổng nhận). Tất cả thiết bị đều kiểm tra yêu cầu nhưng chỉ thiết bị có IPv4 tương ứng mới phản hồi.

[Click to play](https://www.youtube.com/watch?v=6nPOBUgP45c&t=40s)

---

## 9.2.4. Video -  ARP Operation - ARP Reply

Thiết bị khớp IPv4 trong request sẽ gửi lại **ARP Reply dưới dạng unicast**.

| Header Field | Giá trị |
|--------------|---------|
| Destination MAC | MAC của thiết bị gửi (requester) |
| Source MAC | MAC của thiết bị trả lời |
| Type | 0x806 |

Khi nhận reply, thiết bị:

- Cập nhật ARP Table
- Tiếp tục gửi frame đến đúng MAC đích

Nếu không có thiết bị phản hồi → frame không thể tạo và packet bị **drop**.

[Click to play](https://www.youtube.com/watch?v=dFEqT7hvBTA)

---

## 9.2.5. Video - ARP Role in Remote Communications

Nếu IPv4 đích nằm **khác network** so với host, host sẽ gửi gói tin cho **default gateway**.  
MAC đích trong frame sẽ là MAC của router, không phải MAC của IP đích.

Nếu gateway chưa có trong ARP table → host thực hiện ARP để tìm MAC của gateway.

[Click to play](https://www.youtube.com/watch?v=5wpsNlP19QE)

---

## 9.2.6. Removing Entries from an ARP Table

Mỗi mục trong ARP table đều có thời gian sống (**timeout**) và sẽ bị xóa nếu không còn sử dụng.

| Thiết bị/Hệ điều hành | ARP Timeout |
|-----------------------|-------------|
| Windows | 15–45 giây |
| Cisco IOS | ~240 giây (mặc định) |

<p align="center">
  <img src="../../images/kì 1/module 9/9.2.6.jpg" width="520"/>
</p>

Người quản trị có thể xóa thủ công ARP cache, sau đó ARP request sẽ được gửi lại khi cần thiết.

---

## 9.2.7. ARP Tables on Networking Devices

Các lệnh kiểm tra ARP Table:

| Thiết bị / OS | Lệnh |
|---------------|------|
| Cisco Router | `show ip arp` |
| Windows | `arp -a` |
| Linux / macOS | `ip neigh` hoặc `arp -n` |

Ví dụ trên Cisco IOS:
```bash
R1# **show ip arp** 
Protocol  Address          Age (min)  Hardware Addr   Type   Interface
Internet  192.168.10.1            -   a0e0.af0d.e140  ARPA   GigabitEthernet0/0/0
Internet  209.165.200.225         -   a0e0.af0d.e141  ARPA   GigabitEthernet0/0/1
Internet  209.165.200.226         1   a03d.6fe1.9d91  ARPA   GigabitEthernet0/0/1
R1#
```

Ví dụ trên Windows 10:
```bash
C:\Users\PC> **arp -a**
Interface: 192.168.1.124 --- 0x10
  Internet Address      Physical Address      Type
  192.168.1.1           c8-d7-19-cc-a0-86     dynamic
  192.168.1.101         08-3e-0c-f5-f7-77     dynamic
  192.168.1.110         08-3e-0c-f5-f7-56     dynamic
  192.168.1.112         ac-b3-13-4a-bd-d0     dynamic
  192.168.1.117         08-3e-0c-f5-f7-5c     dynamic
  192.168.1.126         24-77-03-45-5d-c4     dynamic
  192.168.1.146         94-57-a5-0c-5b-02     dynamic
  192.168.1.255         ff-ff-ff-ff-ff-ff     static
  224.0.0.22            01-00-5e-00-00-16     static
  224.0.0.251           01-00-5e-00-00-fb     static
  239.255.255.250       01-00-5e-7f-ff-fa     static
  255.255.255.255       ff-ff-ff-ff-ff-ff     static
C:\Users\PC>
```
## 9.2.8. ARP Issues – Broadcast and Spoofing

Vì ARP sử dụng broadcast, nếu bị nhiều thiết bị khởi động cùng lúc, mạng có thể tạm thời bị tải nặng bởi ARP Request.

<p align="center">
  <img src="../../images/kì 1/module 9/9.2.8_1.jpg" width="520"/>
</p>

###  Nguy cơ bảo mật từ ARP: ARP Spoofing và ARP Poisoning


ARP được thiết kế đơn giản và **không có cơ chế xác thực**. Vì vậy, bất kỳ thiết bị nào trong mạng cũng có thể gửi một ARP Reply — ngay cả khi **không ai yêu cầu**.

Điều này mở ra khả năng tấn công được gọi là:

>  **ARP Spoofing / ARP Poisoning**

Cách tấn công diễn ra như sau:

1. Kẻ tấn công theo dõi ARP Request trong mạng (ví dụ: yêu cầu tìm địa chỉ MAC của Default Gateway).
2. Hắn gửi một **ARP Reply giả mạo** với **MAC của chính hắn** thay vì MAC thật của gateway.
3. Thiết bị nạn nhân cập nhật **ARP Cache** với thông tin sai.
4. Từ thời điểm đó, **mọi gói tin gửi đến gateway sẽ bị chuyển qua thiết bị của kẻ tấn công.**

<p align="center">
  <img src="../../images/kì 1/module 9/9.2.8_2.jpg" width="520"/>
</p>

Hắn có thể:

- Nghe lén thông tin (**Man-in-the-Middle attack**)
- Chặn hoặc chỉnh sửa dữ liệu
- Chuyển hướng truy cập sang server giả mạo
- Chiếm quyền truy cập tiếp theo

---

###  Phòng chống tấn công ARP

Trong môi trường doanh nghiệp, các switch Layer 2 hiện đại hỗ trợ nhiều cơ chế bảo mật để giảm nguy cơ tấn công ARP. Một trong số đó là:

- **Dynamic ARP Inspection (DAI)**  
  Tính năng này kiểm tra ARP Reply dựa trên bảng DHCP Snooping hoặc danh sách thiết bị tin cậy, đảm bảo rằng chỉ ARP hợp lệ mới được đưa vào mạng.

>  *DAI vượt quá phạm vi nội dung kì này, nhưng bạn sẽ gặp nhiều trong kì 3 Enterprise.*


