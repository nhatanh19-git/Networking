
| **Title** | 9.3. IPv6 Neighbor Discovery (ND) |
|:---------:|:----------------------------------:|
| **ID**    | CCNET044                           |
| **Tag**   | CCNA, Cisco, IPv6, ICMPv6, NDP, SLAAC |

---

## 9.3.1. Video – IPv6 Neighbor Discovery

Trong mạng **IPv6**, giao thức **Neighbor Discovery (ND hoặc NDP)** đảm nhiệm vai trò giống như ARP trong IPv4 — tức là tìm và ánh xạ địa chỉ **IPv6 ↔ MAC** để giao tiếp được trong cùng mạng LAN.

ND hoạt động dựa trên các thông điệp thuộc giao thức **ICMPv6**, không dùng ARP như IPv4.

[Click to play](https://www.youtube.com/watch?v=hJ7Mc3LLWXI)

---

## 9.3.2. IPv6 Neighbor Discovery Messages

IPv6 ND bao gồm 5 loại thông điệp chính thuộc **ICMPv6**:

| Loại thông điệp | Mục đích |
|----------------|----------|
| **Neighbor Solicitation (NS)** | Tương tự ARP Request – hỏi MAC tương ứng với IPv6 đích |
| **Neighbor Advertisement (NA)** | Tương tự ARP Reply – trả lời MAC của thiết bị |
| **Router Solicitation (RS)** | Host hỏi router về cấu hình mạng, IPv6 prefix |
| **Router Advertisement (RA)** | Router gửi thông tin định tuyến, IPv6 prefix, Default Gateway |
| **Redirect Message** | Router hướng host đến next-hop tốt hơn (học kỹ hơn sau này) |

> Device-to-Device: NS, NA
> Device-Router: RS, RA

ND không chỉ dùng để **tìm MAC** như ARP, mà còn hỗ trợ:
- **Tự động cấu hình IPv6 không trạng thái** (SLAAC - stateless address autoconfiguration)
- **Phát hiện router**
- **Xác định đường đi tốt hơn**

> ND được mô tả trong chuẩn **IETF RFC 4861**.

---

## 9.3.3. IPv6 Neighbor Discovery – Address Resolution

Tương tự ARP trong IPv4, ND sử dụng **Neighbor Solicitation** và **Neighbor Advertisement** để xác định MAC của thiết bị có IPv6 đích.

Ví dụ: PC1 cần ping PC2 tại địa chỉ **2001:db8:acad::11**

Quy trình sẽ diễn ra như sau:

1. PC1 gửi **ICMPv6 Neighbor Solicitation (NS)** tới một **IPv6 multicast đặc biệt**, không broadcast như ARP.

<details>	
Mở rộng: Quy tắc tạo địa chỉ Solicited-Node Multicast
Solicited-Node Multicast Address được tạo theo công thức:
```bash
ff02::1:ffXX:XXXX
```
Trong đó:

- `XX:XXXX` = **24 bit cuối** của địa chỉ IPv6 cần hỏi (Target IPv6)
- Địa chỉ này được dùng trong ICMPv6 Neighbor Solicitation thay cho broadcast trong IPv4

Các bước thực hiện
**Bước 1: Viết đầy đủ địa chỉ IPv6 (expanded form)**
Ví dụ: `2001:db8:acad::11`  
→ `2001:0db8:acad:0000:0000:0000:0000:0011`
**Bước 2: Lấy 24 bit cuối của địa chỉ IPv6**
- 32 bit cuối: `0x00000011`
- 24 bit cuối: `0x000011`

**Bước 3: Gắn 24 bit cuối vào khuôn multicast**
 `ff02::1:ff00:11`
 => Đây là **Solicited-Node Multicast Address** tương ứng với IPv6: `2001:db8:acad::11`
 </details>

2. PC2 nhận NS và trả lời bằng **Neighbor Advertisement (NA)** chứa địa chỉ MAC của nó.
3. PC1 lưu ánh xạ **IPv6 ↔ MAC** vào bảng **Neighbor Cache**.

<p align="center">
  <img src="../../images/kì 1/module 9/9.3.3.jpg" width="550"/>
</p>

| IPv4 (ARP) | IPv6 (ND) |
|------------|-----------|
| Broadcast ARP Request | Multicast Neighbor Solicitation |
| Unicast ARP Reply | Unicast/Multicast Neighbor Advertisement |
| ARP Table | Neighbor Cache |

> Việc sử dụng **multicast thay vì broadcast** giúp IPv6 hiệu quả hơn, giảm lãng phí tài nguyên mạng.


